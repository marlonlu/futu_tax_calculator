# 测试数据说明

本目录包含用于验证股票期权交易盈利统计脚本的测试用例。每个测试用例都放在独立的文件夹中，便于管理和理解。

## 测试用例目录结构

### 股票测试用例

| 目录名 | 测试场景 | 预期结果 |
|--------|----------|----------|
| `01_股票同年完整交易` | 当年度完整买卖流水 | 正常计算盈亏，按移动加权平均算法匹配 |
| `02_股票跨年部分卖出` | 当年买入，跨年部分卖出 | 盈利分别计入对应年度 |
| `03_股票仅卖出无买入` | 只有卖出，无买入记录 | 标记为需要手动核查 |
| `04_股票当年买次年卖` | 当年买入，次年全部卖出 | 盈利计入卖出年度 |
| `05_股票复杂交易场景` | 复杂交易匹配场景 | 验证移动加权平均算法正确性 |

### 期权测试用例

| 目录名 | 测试场景 | 预期结果 |
|--------|----------|----------|
| `06_期权做多同年交易` | 期权做多，当年度完整交易 | 期权价格乘以100，正常盈亏计算 |
| `07_期权做多跨年交易` | 期权做多，跨年交易 | 跨年度盈利计算 |
| `08_期权做空同年交易` | 期权做空，当年度完整交易 | 做空盈利计算 |
| `09_期权做空跨年交易` | 期权做空，跨年交易 | 跨年度做空盈利 |
| `10_期权做多到期作废` | 期权做多，无效（到期作废） | 识别未平仓期权 |
| `11_期权做空到期获利` | 期权卖空，作废（到期获利） | 做空到期获利，成本价为0 |
| `12_期权复杂混合交易` | 期权复杂混合交易场景 | 复杂期权交易处理 |
| `13_期权跨年复杂场景` | 期权跨年复杂场景 | 跨年复杂期权处理 |

### 综合测试用例

| 目录名 | 测试场景 | 预期结果 |
|--------|----------|----------|
| `14_股票期权混合交易` | 股票期权混合交易 | 分别处理股票和期权 |
| `15_无效数据处理测试` | 无效数据处理测试 | 过滤无效数据，记录错误原因 |

## 使用方法

每个测试用例文件夹包含：
- `test_data.csv`: 测试数据文件
- `README.md`: 详细的测试说明文档

### 运行单个测试用例

```bash
# 运行单个测试用例
python tax/stock_option_tax_calculator.py --input test_data/01_股票同年完整交易/test_data.csv --output test_data/01_股票同年完整交易/
```

### 运行所有测试用例

```bash
python tax/test_calculator.py
```

## 验证重点

1. **移动加权平均算法**：验证加权平均成本价计算的正确性
2. **期权价格处理**：确认期权价格正确乘以100倍合约乘数
3. **跨年度处理**：验证年度分组和盈利分配到卖出年度
4. **异常数据处理**：确认无效数据的过滤和标记
5. **期权到期处理**：验证未平仓期权的到期处理逻辑
6. **双向期权交易**：验证做多做空混合交易的正确处理

## 算法说明

本项目使用**移动加权平均算法**进行税务计算：

### 移动加权平均算法原理
- **买入时**: 对齐富途成本计算公式是，买入价格 * 买入数量 + 手续费， 然后 除以 买入数量
- **买入时**: 更新持仓数量和总成本，重新计算平均成本价
- **卖出时**: 按当前平均成本价计算盈亏
- **公式**: 新平均成本 = (原持仓成本 + 新买入成本) ÷ (原持仓数量 + 新买入数量)

### 示例
```
买入100股@$10 → 平均成本$10
买入200股@$15 → 平均成本$13.33 ((100×10+200×15)÷300)
卖出150股@$20 → 盈利$1000 ((20-13.33)×150)，剩余150股@$13.33
```

## 数据格式

所有测试数据文件都遵循以下CSV格式：
```
股票代码,数量,成交价格,买卖方向,结算币种,合计手续费,交易时间
```

- **股票代码**: 如 `US.AAPL`（股票）或 `US.AAPL240315P160000`（期权）
- **数量**: 交易数量
- **成交价格**: 成交价格
- **买卖方向**: `buy` 或 `sell`
- **结算币种**: `USD`、`HKD` 等
- **合计手续费**: 交易手续费
- **交易时间**: 格式为 `YYYY-MM-DD HH:MM:SS`

## 注意事项

1. **文件夹命名**: 部分文件夹名称中包含"FIFO"是历史遗留，实际使用移动加权平均算法
2. **期权处理**: 期权价格自动乘以100倍合约乘数
3. **跨年交易**: 盈利计入卖出年度，不是买入年度
4. **容差设置**: 测试对比时设置了合理的数值容差范围