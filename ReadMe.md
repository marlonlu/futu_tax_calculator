# 富途税务计算器

一个用于计算富途证券交易税务的 Python 工具，支持股票和期权交易的税务计算，使用移动加权平均算法计算成本基础。

## 功能特性

- 🔄 **数据获取**: 自动下载富途历史成交订单和现金流数据
- 📊 **税务计算**: 支持股票和期权交易的税务计算
- 📈 **算法支持**: 使用移动加权平均算法计算成本基础
- 📋 **报告生成**: 按年度生成详细的税务报告 CSV 文件
- 🧪 **自动测试**: 内置测试框架，支持多种交易场景验证

## Python 环境设置

### 在你的项目目录下
#### 1. 创建虚拟环境 (例如，名为 venv)
```bash
python3 -m venv venv
```

#### 2. 激活虚拟环境
```bash
source venv/bin/activate
```

#### 3. 在虚拟环境中，你可以安全地使用 pip
```bash
pip install -r requirements.txt
```

#### 4. 完成工作后，退出虚拟环境
```bash
deactivate
```

## 核心模块详解

### 1. 数据获取模块 (futu/)

#### `futu/download_history_flow.py` - 历史成交订单下载器
> 务必
**功能**: 用于获取富途证券历史成交订单数据
- **连接管理**: 支持本地和远程富途 OpenD 网关连接
- **多账户支持**: 自动遍历所有真实交易账户（跳过模拟账户）
- **批量下载**: 按3个月为批次分段下载，避免API限制
- **费用查询**: 自动批量查询订单手续费信息
- **数据处理**: 
  - 生成原始数据文件 `data/futu_history_raw.csv`
  - 生成标准化格式文件 `data/futu_history.csv`
- **限流保护**: 内置请求频率限制器（30秒内最多9次请求）

#### `futu/download_cash_flow.py` - 现金流下载器  
**功能**: 用于下载美股、港股市场的股息及股息税数据
- **股息识别**: 自动识别美股股息（SHARES DIVIDENDS）和股息税（SHARES WITHHOLDING TAX）
- **港股支持**: 识别港股现金种子分红
- **多币种**: 支持 USD 和 HKD 两种结算币种
- **去重处理**: 基于 cashflow_id 自动去除重复记录
- **输出格式**: 生成 `data/futu_cash_flow.csv`

### 2. 税务计算模块 (tax/)

#### `tax/stock_option_tax_calculator.py` - 核心税务计算引擎
**功能**: 按年度移动加权平均算法计算年度盈利，并按不同年度输出到不同 CSV
**核心算法**:
- **移动加权平均**: 买入时更新平均成本，卖出时按平均成本计算盈亏
- **股票处理**: 
  - 处理卖空场景（标记需人工核查）
  - 跨年度成本结转
- **期权处理**:
  - 支持做多/做空双向交易
  - 精确追踪多头和空头头寸
  - 自动处理期权到期场景
  - 100倍合约乘数计算

**输出特性**:
- 按年度生成独立报告文件（如 `2024_report.csv`）
- 按币种分别汇总年度盈亏
- 自动计算并显示手续费总额
- 支持 RSU 数据合并处理

#### `tax/test_calculator.py` - 自动化测试框架
**功能**: 自动在不同用例文件下生成盈利总结 CSV，并与当前用例结果 CSV 文件对比，判断当前用例是否通过

**测试流程**:
1. **用例发现**: 自动遍历 `test_data/` 下所有包含 `test_data.csv` 的目录
2. **报告生成**: 为每个用例调用税务计算引擎生成报告
3. **结果对比**: 
   - 基于股票代码和时间创建唯一键进行匹配
   - 设置合理的数值容差（期权0.1，股票1.0）
   - 跳过年度汇总行的比较
4. **测试验证**: 输出详细的通过/失败信息

## 数据获取流程

### 富途牛牛（Futu）数据下载
1. **API准备**：
   - 安装富途OpenD网关并启动，确保本地11111端口可用，也可以根据文档自行配置端口，注意在.env更改即可
   - 如果需要跨网，则需要参考[富途OpenAPI文档](https://openapi.futunn.com/)设置私钥处理
   -  切记futu 已经退出大陆运营，这个文档地址需要翻墙，ip 不可是中国大陆 ip
   - 确保 FutuOpenD 运行一切就绪后，在本项目根目录新建.env,内容如下
```dotenv
# 地址跟端口按具体情况配置，一般默认是127.0.0.1和11111
FUTU_ADDRESS=127.0.0.1
FUTU_PORT=11111
FUTU_ENV=REAL
# 如果address不是本地，必须配合futu opend设置密钥路径 解密
# FUTU_RSA=

```
2. **下载交易订单交易成交流水**：
   ```bash
   python futu/download_history_flow.py
   ```
   - 自动批量下载所有账户的历史订单
   - 生成 `data/futu_history.csv`
3. **下载港股 美股股息流水**：
   ```bash
   python futu/download_cash_flow.py
   ```
   - 自动批量下载所有账户的历史股息及美股股息税
   - 生成 `data/futu_cash_flow.csv`
   - 富途查询结口无法直接查询股息及股息税，所以为了遍历查找，只能每日检查账户的资金流水，判断如下条件则认为是股息&股息税
     - 查询流水货币是 USD，且cashflow_remark包含SHARES DIVIDENDS 或者 SHARES WITHHOLDING TAX
     - 查询流水货币是 HKD，且cashflow_type 是现金种子
   - 这个接口只支持逐日查询，而且限制 30s 并发 20次，如果遍历查询 2022-2024，耗时需要 2 小时左右
4. **富途&中银国际解禁 RSU合并计算**
   - 在 data 目录下新建立futu_rsu_history.csv，可参考示例_futu_rsu_history.csv添加买入 卖出
   - ✅ futu_rsu_history.csv 针对公司授予的解禁性股票自己人工导入赋予流水，
   - 股票代码,数量,成交价格（授予价格可在公司解禁页面可查看）,买卖方向（Buy是授予，Sell 是自己去中银国际 App 卖出）,结算币种,合计手续费,交易时间
     - futu&中银国际 解禁无法通过 api查询，在公司解禁页面有完整记录，需要个人工添加授予记录，
     - 富途平台涉及卖出股票不需要，会自动获取流水
     - 中银国际上卖出需要去查询成交记录，人工添加卖出价格、数量、手续费，这平台没 api 自动获取
     
## 税务计算使用方法

### 1. 基本税务计算
**移动平均等权计算流水及年度盈利**：
```bash
python tax/stock_option_tax_calculator.py
```
- 自动在税务报告文件夹下生成流水 CSV，例如 `税务报告/2024_report.csv`
- 支持自定义输入文件和输出目录：
```bash
python tax/stock_option_tax_calculator.py --input data/custom_trades.csv --output reports/
```

### 2. 自动化测试验证
**运行测试用例**：
```bash
python tax/test_calculator.py
```
- 自动在不同用例文件下生成盈利总结 CSV，例如 `2024_report.csv`
- 与当前用例结果 CSV 文件对比，判断计算逻辑是否正确
- 如果不通过用例，则提示具体问题和差异

## 支持的交易场景

### 股票交易
- ✅ 同年完整买卖交易
- ✅ 跨年部分卖出
- ✅ 仅卖出无买入（标记需人工核查）
- ✅ 当年买次年卖
- ✅ 复杂 FIFO 场景
- ⚠️ 卖空股票（会在流水表注明需要人工核查）

### 期权交易
- ✅ 期权做多同年交易
- ✅ 期权做多跨年交易  
- ✅ 期权做空同年交易
- ✅ 期权做空跨年交易
- ✅ 期权做多到期作废
- ✅ 期权做空到期获利
- ✅ 期权复杂混合交易
- ✅ 期权跨年复杂场景

### 混合场景
- ✅ 股票期权混合交易
- ✅ 无效数据处理测试

### 平台支持
- ✅ 富途牛牛（Futu）平台
- ❌ 长桥平台（需要额外 API 及期权识别设置）
- ❌ 轮证、涡轮、期货等其他产品（需基于测试用例自行验证）
- ❌ 公司授予的期权不知道流水跟具体结构，需要自行参考futu_rsu_history人工导入 

### 数据格式
最终生成的流水 CSV 格式：
```
股票代码,数量,成交价格,买卖方向,结算币种,合计手续费,交易时间
```

## 测试用例说明

### 测试用例结构
在 `test_data/` 下存放了15个完整的测试场景，覆盖各种复杂交易情况：

- **01-05**: 股票交易场景
  - `01_股票同年完整交易/`
  - `02_股票跨年部分卖出/`
  - `03_股票仅卖出无买入/`
  - `04_股票当年买次年卖/`
  - `05_股票复杂FIFO场景/`

- **06-13**: 期权交易场景
  - `06_期权做多同年交易/`
  - `07_期权做多跨年交易/`
  - `08_期权做空同年交易/`
  - `09_期权做空跨年交易/`
  - `10_期权做多到期作废/`
  - `11_期权做空到期获利/`
  - `12_期权复杂混合交易/`
  - `13_期权跨年复杂场景/`

- **14-15**: 特殊场景
  - `14_股票期权混合交易/`
  - `15_无效数据处理测试/`

### 测试用例组成
每个测试用例目录包含：
- `test_data.csv`: 输入的交易数据
- `test_data_YYYY.csv`: 预期的计算结果（按年份）
- 运行测试后生成的 `YYYY_report.csv`: 实际计算结果

### 重要说明
- 所有用例都基于**移动平均等权计算**算法
- 如果修改计税逻辑，务必确保所有用例都能运行通过
- 测试框架会自动对比预期结果和实际结果，确保计算准确性

## 项目结构

```
futu_tax_calculator/
├── data/                   # 原始数据文件目录
│   ├── futu_history.csv   # 标准化交易数据
│   ├── futu_history_raw.csv # 富途下载 的原始交易数据
│   └── futu_cash_flow.csv # 股息现金流数据
│   └── futu_rsu_history.csv # 针对公司授予的解禁性股票
├── futu/                   # 富途数据获取模块
│   ├── download_history_flow.py  # 历史成交订单下载
│   └── download_cash_flow.py     # 股息现金流下载
├── tax/                    # 税务计算核心模块
│   ├── stock_option_tax_calculator.py  # 税务计算引擎
│   └── test_calculator.py              # 自动化测试框架
├── test_data/              # 测试用例数据（15个场景）
│   ├── 01_股票同年完整交易/
│   ├── 02_股票跨年部分卖出/
│   └── ... (共15个测试场景)
├── 税务报告/               # 生成的年度税务报告
├── requirements.txt        # Python 依赖包
└── ReadMe.md              # 项目说明文档
```